

.. _sphx_glr_auto_examples_connectivity_plot_canica_resting_state.py:


Group analysis of resting-state fMRI with ICA: CanICA
=====================================================

An example applying CanICA to resting-state data. This example applies it
to 40 subjects of the ADHD200 datasets. Then it plots a map with all the
components together and an axial cut for each of the components separately.

CanICA is an ICA method for group-level analysis of fMRI data. Compared
to other strategies, it brings a well-controlled group model, as well as a
thresholding algorithm controlling for specificity and sensitivity with
an explicit model of the signal. The reference papers are:

    * G. Varoquaux et al. "A group model for stable multi-subject ICA on
      fMRI datasets", NeuroImage Vol 51 (2010), p. 288-299

    * G. Varoquaux et al. "ICA-based sparse features recovery from fMRI
      datasets", IEEE ISBI 2010, p. 1177

Pre-prints for both papers are available on hal
(http://hal.archives-ouvertes.fr)

First we load the ADHD200 data


.. code-block:: python

    from nilearn import datasets

    adhd_dataset = datasets.fetch_adhd(n_subjects=30)
    func_filenames = adhd_dataset.func  # list of 4D nifti files for each subject

    # print basic information on the dataset
    print('First functional nifti image (4D) is at: %s' %
          adhd_dataset.func[0])  # 4D data





.. rst-class:: sphx-glr-horizontal



.. rst-class:: sphx-glr-script-out

 **Output**:


  ::

    First functional nifti image (4D) is at: /home/varoquau/nilearn_data/adhd/data/0010042/0010042_rest_tshift_RPI_voreg_mni.nii.gz


Here we apply CanICA on the data


.. code-block:: python

    from nilearn.decomposition.canica import CanICA

    canica = CanICA(n_components=20, smoothing_fwhm=6.,
                    memory="nilearn_cache", memory_level=5,
                    threshold=3., verbose=10, random_state=0)
    canica.fit(func_filenames)

    # Retrieve the independent components in brain space
    components_img = canica.masker_.inverse_transform(canica.components_)
    # components_img is a Nifti Image object, and can be saved to a file with
    # the following line:
    components_img.to_filename('canica_resting_state.nii.gz')





.. rst-class:: sphx-glr-horizontal



.. rst-class:: sphx-glr-script-out

 **Output**:


  ::

    [MultiNiftiMasker.fit] Loading data from [/home/varoquau/nilearn_data/adhd/data/0010042/0010042_rest_tshift_RPI_voreg_mni.nii.gz, /home/varoquau/nilearn_data/adhd/data/0010064/0010064_rest_tshift_RPI_voreg_mni.nii.gz, /home/varoquau/nilearn_
    [MultiNiftiMasker.fit] Computing mask
    [Memory]    0.0s, 0.0min: Loading compute_multi_epi_mask from nilearn_cache/joblib/nilearn/masking/compute_multi_epi_mask/c366a85b2a0e76c3ab2c0597fef5597b
    ______________________________compute_multi_epi_mask cache loaded - 0.0s, 0.0min
    [MultiNiftiMasker.transform] Resampling mask
    ________________________________________________________________________________
    [Memory] Calling nilearn.image.resampling.resample_img...
    resample_img(<nibabel.nifti1.Nifti1Image object at 0x7fd40ea84250>, target_shape=None, target_affine=None, copy=False, interpolation='nearest')
    _____________________________________________________resample_img - 0.0s, 0.0min
    [Memory]    0.0s, 0.0min: Loading filter_and_mask from nilearn_cache/joblib/nilearn/input_data/nifti_masker/filter_and_mask/ac5e1d829aec0ee6ebd36440f3b6f276
    _____________________________________filter_and_mask cache loaded - 0.2s, 0.0min
    [Memory]    0.3s, 0.0min: Loading filter_and_mask from nilearn_cache/joblib/nilearn/input_data/nifti_masker/filter_and_mask/9a53da214e8c6cdcfe1581b2bda984e4
    _____________________________________filter_and_mask cache loaded - 0.2s, 0.0min
    [Memory]    0.6s, 0.0min: Loading filter_and_mask from nilearn_cache/joblib/nilearn/input_data/nifti_masker/filter_and_mask/d136b864058b9692bfc24cdac1689279
    _____________________________________filter_and_mask cache loaded - 0.2s, 0.0min
    [Memory]    0.9s, 0.0min: Loading filter_and_mask from nilearn_cache/joblib/nilearn/input_data/nifti_masker/filter_and_mask/24600dab54bf52b7f417b719eb0754ee
    _____________________________________filter_and_mask cache loaded - 0.2s, 0.0min
    [Memory]    1.2s, 0.0min: Loading filter_and_mask from nilearn_cache/joblib/nilearn/input_data/nifti_masker/filter_and_mask/48837d5530d211646d054c3bc24bd9a2
    _____________________________________filter_and_mask cache loaded - 0.1s, 0.0min
    [Memory]    1.4s, 0.0min: Loading filter_and_mask from nilearn_cache/joblib/nilearn/input_data/nifti_masker/filter_and_mask/4ba566263d70f12a31fdc5d681df4cc9
    _____________________________________filter_and_mask cache loaded - 0.1s, 0.0min
    [Memory]    1.6s, 0.0min: Loading filter_and_mask from nilearn_cache/joblib/nilearn/input_data/nifti_masker/filter_and_mask/705e794952ab60bce971ca627e7cf44e
    _____________________________________filter_and_mask cache loaded - 0.2s, 0.0min
    [Memory]    1.9s, 0.0min: Loading filter_and_mask from nilearn_cache/joblib/nilearn/input_data/nifti_masker/filter_and_mask/7e30775896e5faf2d3f511489f355b5d
    _____________________________________filter_and_mask cache loaded - 0.1s, 0.0min
    [Memory]    2.2s, 0.0min: Loading filter_and_mask from nilearn_cache/joblib/nilearn/input_data/nifti_masker/filter_and_mask/c7880ad0e620c323693dea3473dbbcbd
    _____________________________________filter_and_mask cache loaded - 0.1s, 0.0min
    [Memory]    2.5s, 0.0min: Loading filter_and_mask from nilearn_cache/joblib/nilearn/input_data/nifti_masker/filter_and_mask/5c6714d8dac2e49cbf5466d739d73ac4
    _____________________________________filter_and_mask cache loaded - 0.1s, 0.0min
    [Memory]    2.8s, 0.0min: Loading filter_and_mask from nilearn_cache/joblib/nilearn/input_data/nifti_masker/filter_and_mask/3cbfb3a44c1ddc38cfcc00178fe0163c
    _____________________________________filter_and_mask cache loaded - 0.1s, 0.0min
    [Memory]    3.0s, 0.1min: Loading filter_and_mask from nilearn_cache/joblib/nilearn/input_data/nifti_masker/filter_and_mask/d94eabd75c09025395aaec9f45e6cc46
    _____________________________________filter_and_mask cache loaded - 0.1s, 0.0min
    [Memory]    3.2s, 0.1min: Loading filter_and_mask from nilearn_cache/joblib/nilearn/input_data/nifti_masker/filter_and_mask/d4a30bbc279e6c9d6d5123073ea8ec2a
    _____________________________________filter_and_mask cache loaded - 0.1s, 0.0min
    [Memory]    3.4s, 0.1min: Loading filter_and_mask from nilearn_cache/joblib/nilearn/input_data/nifti_masker/filter_and_mask/8163de268bd01e7629594a1c31b865bd
    _____________________________________filter_and_mask cache loaded - 0.1s, 0.0min
    [Memory]    3.7s, 0.1min: Loading filter_and_mask from nilearn_cache/joblib/nilearn/input_data/nifti_masker/filter_and_mask/337d5a1bbff55e2c2477163e1d6fb9c2
    _____________________________________filter_and_mask cache loaded - 0.0s, 0.0min
    [Memory]    3.8s, 0.1min: Loading filter_and_mask from nilearn_cache/joblib/nilearn/input_data/nifti_masker/filter_and_mask/1340624723a1eda45738bad9f59453a3
    _____________________________________filter_and_mask cache loaded - 0.1s, 0.0min
    [Memory]    4.1s, 0.1min: Loading filter_and_mask from nilearn_cache/joblib/nilearn/input_data/nifti_masker/filter_and_mask/1a02228a8bd62872698a471d2ccf9c7a
    _____________________________________filter_and_mask cache loaded - 0.0s, 0.0min
    [Memory]    4.2s, 0.1min: Loading filter_and_mask from nilearn_cache/joblib/nilearn/input_data/nifti_masker/filter_and_mask/4ebe292e1b9ba9f6d000199434d23ce5
    _____________________________________filter_and_mask cache loaded - 0.1s, 0.0min
    [Memory]    4.5s, 0.1min: Loading filter_and_mask from nilearn_cache/joblib/nilearn/input_data/nifti_masker/filter_and_mask/664f8d627f6a11772dbabb4e52a60609
    _____________________________________filter_and_mask cache loaded - 0.1s, 0.0min
    [Memory]    4.7s, 0.1min: Loading filter_and_mask from nilearn_cache/joblib/nilearn/input_data/nifti_masker/filter_and_mask/9533a6640ad6456af340be401b413b35
    _____________________________________filter_and_mask cache loaded - 0.2s, 0.0min
    [Memory]    5.1s, 0.1min: Loading filter_and_mask from nilearn_cache/joblib/nilearn/input_data/nifti_masker/filter_and_mask/5840c3d1e9ad5ecbcb27258130fecb0c
    _____________________________________filter_and_mask cache loaded - 0.2s, 0.0min
    [Memory]    5.5s, 0.1min: Loading filter_and_mask from nilearn_cache/joblib/nilearn/input_data/nifti_masker/filter_and_mask/c35b1bc8a5a3e478dcf0b420842a5ee2
    _____________________________________filter_and_mask cache loaded - 0.1s, 0.0min
    [Memory]    5.8s, 0.1min: Loading filter_and_mask from nilearn_cache/joblib/nilearn/input_data/nifti_masker/filter_and_mask/21bae30649cbc90329c024eeb0827e4d
    _____________________________________filter_and_mask cache loaded - 0.2s, 0.0min
    [Memory]    6.1s, 0.1min: Loading filter_and_mask from nilearn_cache/joblib/nilearn/input_data/nifti_masker/filter_and_mask/1c027c89ad1d61f954d5e58af0712b72
    _____________________________________filter_and_mask cache loaded - 0.2s, 0.0min
    [Memory]    6.4s, 0.1min: Loading filter_and_mask from nilearn_cache/joblib/nilearn/input_data/nifti_masker/filter_and_mask/665a2405c1a0d849411b26fe1ff4bad1
    _____________________________________filter_and_mask cache loaded - 0.1s, 0.0min
    [Memory]    6.7s, 0.1min: Loading filter_and_mask from nilearn_cache/joblib/nilearn/input_data/nifti_masker/filter_and_mask/d2995ee30ddb97276c36f8b10d75edc8
    _____________________________________filter_and_mask cache loaded - 0.2s, 0.0min
    [Memory]    6.9s, 0.1min: Loading filter_and_mask from nilearn_cache/joblib/nilearn/input_data/nifti_masker/filter_and_mask/f39f3ffce42b21aba246e112e133854c
    _____________________________________filter_and_mask cache loaded - 0.1s, 0.0min
    [Memory]    7.1s, 0.1min: Loading filter_and_mask from nilearn_cache/joblib/nilearn/input_data/nifti_masker/filter_and_mask/e9314836c7a7922022e565c37ec46dd9
    _____________________________________filter_and_mask cache loaded - 0.2s, 0.0min
    [Memory]    7.4s, 0.1min: Loading filter_and_mask from nilearn_cache/joblib/nilearn/input_data/nifti_masker/filter_and_mask/b209e2291da6eac2dc7cc539cccbe868
    _____________________________________filter_and_mask cache loaded - 0.1s, 0.0min
    [Memory]    7.7s, 0.1min: Loading filter_and_mask from nilearn_cache/joblib/nilearn/input_data/nifti_masker/filter_and_mask/0f267cca15448fdf933c4897efc3fdea
    _____________________________________filter_and_mask cache loaded - 0.0s, 0.0min
    [Memory]    0.5s, 0.0min: Loading randomized_svd from nilearn_cache/joblib/sklearn/utils/extmath/randomized_svd/f49a2ffeb28a32a3126d765c989ced90
    ______________________________________randomized_svd cache loaded - 0.0s, 0.0min
    ________________________________________________________________________________
    [Memory] Calling sklearn.decomposition.fastica_.fastica...
    fastica(array([[ 0.002901, ..., -0.004405],
           ..., 
           [ 0.003501, ...,  0.004469]]), fun='cube', random_state=209652396, whiten=True)
    __________________________________________________________fastica - 2.3s, 0.0min
    ________________________________________________________________________________
    [Memory] Calling sklearn.decomposition.fastica_.fastica...
    fastica(array([[ 0.002901, ..., -0.004405],
           ..., 
           [ 0.003501, ...,  0.004469]]), fun='cube', random_state=398764591, whiten=True)
    __________________________________________________________fastica - 5.8s, 0.1min
    ________________________________________________________________________________
    [Memory] Calling sklearn.decomposition.fastica_.fastica...
    fastica(array([[ 0.002901, ..., -0.004405],
           ..., 
           [ 0.003501, ...,  0.004469]]), fun='cube', random_state=924231285, whiten=True)
    __________________________________________________________fastica - 2.1s, 0.0min
    ________________________________________________________________________________
    [Memory] Calling sklearn.decomposition.fastica_.fastica...
    fastica(array([[ 0.002901, ..., -0.004405],
           ..., 
           [ 0.003501, ...,  0.004469]]), fun='cube', random_state=1478610112, whiten=True)
    __________________________________________________________fastica - 3.5s, 0.1min
    ________________________________________________________________________________
    [Memory] Calling sklearn.decomposition.fastica_.fastica...
    fastica(array([[ 0.002901, ..., -0.004405],
           ..., 
           [ 0.003501, ...,  0.004469]]), fun='cube', random_state=441365315, whiten=True)
    __________________________________________________________fastica - 2.1s, 0.0min
    ________________________________________________________________________________
    [Memory] Calling sklearn.decomposition.fastica_.fastica...
    fastica(array([[ 0.002901, ..., -0.004405],
           ..., 
           [ 0.003501, ...,  0.004469]]), fun='cube', random_state=1537364731, whiten=True)
    __________________________________________________________fastica - 2.4s, 0.0min
    ________________________________________________________________________________
    [Memory] Calling sklearn.decomposition.fastica_.fastica...
    fastica(array([[ 0.002901, ..., -0.004405],
           ..., 
           [ 0.003501, ...,  0.004469]]), fun='cube', random_state=192771779, whiten=True)
    __________________________________________________________fastica - 3.6s, 0.1min
    ________________________________________________________________________________
    [Memory] Calling sklearn.decomposition.fastica_.fastica...
    fastica(array([[ 0.002901, ..., -0.004405],
           ..., 
           [ 0.003501, ...,  0.004469]]), fun='cube', random_state=1491434855, whiten=True)
    __________________________________________________________fastica - 2.6s, 0.0min
    ________________________________________________________________________________
    [Memory] Calling sklearn.decomposition.fastica_.fastica...
    fastica(array([[ 0.002901, ..., -0.004405],
           ..., 
           [ 0.003501, ...,  0.004469]]), fun='cube', random_state=1819583497, whiten=True)
    __________________________________________________________fastica - 2.4s, 0.0min
    ________________________________________________________________________________
    [Memory] Calling sklearn.decomposition.fastica_.fastica...
    fastica(array([[ 0.002901, ..., -0.004405],
           ..., 
           [ 0.003501, ...,  0.004469]]), fun='cube', random_state=530702035, whiten=True)
    __________________________________________________________fastica - 7.1s, 0.1min
    ________________________________________________________________________________
    [Memory] Calling nilearn.masking.unmask...
    unmask(array([[-0., ..., -0.],
           ..., 
           [-0., ..., -0.]]), <nibabel.nifti1.Nifti1Image object at 0x7fd40ea84250>)
    ___________________________________________________________unmask - 0.1s, 0.0min


To visualize we plot the outline of all components on one figure


.. code-block:: python

    from nilearn.plotting import plot_prob_atlas

    # Plot all ICA components together
    plot_prob_atlas(components_img, title='All ICA components')





.. image:: /auto_examples/connectivity/images/sphx_glr_plot_canica_resting_state_001.png
    :align: center




Finally, we plot the map for each ICA component separately


.. code-block:: python

    from nilearn.image import iter_img
    from nilearn.plotting import plot_stat_map, show

    for i, cur_img in enumerate(iter_img(components_img)):
        plot_stat_map(cur_img, display_mode="z", title="IC %d" % i,
                      cut_coords=1, colorbar=False)

    show()



.. rst-class:: sphx-glr-horizontal


    *

      .. image:: /auto_examples/connectivity/images/sphx_glr_plot_canica_resting_state_002.png
            :scale: 47

    *

      .. image:: /auto_examples/connectivity/images/sphx_glr_plot_canica_resting_state_003.png
            :scale: 47

    *

      .. image:: /auto_examples/connectivity/images/sphx_glr_plot_canica_resting_state_004.png
            :scale: 47

    *

      .. image:: /auto_examples/connectivity/images/sphx_glr_plot_canica_resting_state_005.png
            :scale: 47

    *

      .. image:: /auto_examples/connectivity/images/sphx_glr_plot_canica_resting_state_006.png
            :scale: 47

    *

      .. image:: /auto_examples/connectivity/images/sphx_glr_plot_canica_resting_state_007.png
            :scale: 47

    *

      .. image:: /auto_examples/connectivity/images/sphx_glr_plot_canica_resting_state_008.png
            :scale: 47

    *

      .. image:: /auto_examples/connectivity/images/sphx_glr_plot_canica_resting_state_009.png
            :scale: 47

    *

      .. image:: /auto_examples/connectivity/images/sphx_glr_plot_canica_resting_state_010.png
            :scale: 47

    *

      .. image:: /auto_examples/connectivity/images/sphx_glr_plot_canica_resting_state_011.png
            :scale: 47

    *

      .. image:: /auto_examples/connectivity/images/sphx_glr_plot_canica_resting_state_012.png
            :scale: 47

    *

      .. image:: /auto_examples/connectivity/images/sphx_glr_plot_canica_resting_state_013.png
            :scale: 47

    *

      .. image:: /auto_examples/connectivity/images/sphx_glr_plot_canica_resting_state_014.png
            :scale: 47

    *

      .. image:: /auto_examples/connectivity/images/sphx_glr_plot_canica_resting_state_015.png
            :scale: 47

    *

      .. image:: /auto_examples/connectivity/images/sphx_glr_plot_canica_resting_state_016.png
            :scale: 47

    *

      .. image:: /auto_examples/connectivity/images/sphx_glr_plot_canica_resting_state_017.png
            :scale: 47

    *

      .. image:: /auto_examples/connectivity/images/sphx_glr_plot_canica_resting_state_018.png
            :scale: 47

    *

      .. image:: /auto_examples/connectivity/images/sphx_glr_plot_canica_resting_state_019.png
            :scale: 47

    *

      .. image:: /auto_examples/connectivity/images/sphx_glr_plot_canica_resting_state_020.png
            :scale: 47

    *

      .. image:: /auto_examples/connectivity/images/sphx_glr_plot_canica_resting_state_021.png
            :scale: 47




**Total running time of the script:**
(0 minutes 49.137 seconds)



.. container:: sphx-glr-download

    **Download Python source code:** :download:`plot_canica_resting_state.py <plot_canica_resting_state.py>`
